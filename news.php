<?php
use function PHPSTORM_META\elementType;

$vulnerable = false; // Si esta valor es igual a false, la web es vulnerable, si se pone a True se solventa la vulnerabilidad.
$defaultNew = true;

if(!$vulnerable){
  if (isset($_GET['id'])){
      include ("conn/conexion.php"); 
      $defaultNew = false;
      // 1)Obtener id de la URL
      $id = $_GET['id'];
      // 2) Se muestra la noticia según el id que viene por la URL
      $query = "SELECT * FROM news WHERE Id = $id";
      // 3) Se ejecuta la query
      $result = mysqli_query($connection, $query);
      if(@mysqli_num_rows($result)==0){
        die('Error');
      }
      if(!$result) 
        echo "ERROR: No se ha podido realizar la consulta."; 
  }
}
else{
  if (isset($_GET['id'])){
    include ("conn/conexion.php"); 

    $defaultNew = false;
    // 1)Obtener id de la URL
    $id = $_GET['id'];
    $query = $pdo->prepare("SELECT * FROM news WHERE Id = :id");
    $pdo->setAttribute(PDO::ATTR_EMULATE_PREPARES, false);
    $query->bindParam(":id", $id, PDO::PARAM_INT);
    $query->execute();
    $result = $query->fetchAll();
  }
}
?>

<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Practica Seguretat i pentesting de servidors de dades</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>

<body>
  <div class="container py-4">
    <header class="pb-3 mb-4 border-bottom">
      <h2>Seguretat i pentesting de servidors de dades - Blind SQL</h2>
    </header>

    <div class="p-5 mb-4 bg-light rounded-3">
      <div class="container-fluid py-5">
        <h1 class="display-5 fw-bold">Noticias sobre vulnerabilidades</h1>
        <article class="blog-post">
        <?php
        if(!$vulnerable){
          if(!$defaultNew){
            while ($field=mysqli_fetch_array($result)){
              echo'<h2 class="blog-post-title">'. $field[1] .'</h2>';
              echo'<p class="blog-post-meta">'.$field[3] .'</p>';
              echo'<p>'.$field[2].'</p>';
            }
          }
          else{
            echo'<h2 class="blog-post-title">Esta noticia es la que viene por defecto</h2>';
            echo'<p class="blog-post-meta">27/04/1985</p>';
            echo'<p>Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book.</p>
            <p>It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.</p></p>';
          }
        }
        else{
          if(!$defaultNew){
            foreach ($result as &$field) {
              echo'<h2 class="blog-post-title">'. $field[1] .'</h2>';
              echo'<p class="blog-post-meta">'.$field[3] .'</p>';
              echo'<p>'.$field[2].'</p>';
            }   
          }
          else{
            echo'<h2 class="blog-post-title">Esta noticia es la que viene por defecto</h2>';
            echo'<p class="blog-post-meta">27/04/1985</p>';
            echo'<p>Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book.</p>
            <p>It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.</p></p>';
          }
        }
        ?>
        </article>
      </div>
    </div>

    <footer class="pt-3 mt-4 text-muted border-top">
      Saúl Cordero 2021 | <a href="index.php">Ir a pagina principal</a>
    </footer>
  </div>
</body>
<?php
die();
?>
<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

</html>